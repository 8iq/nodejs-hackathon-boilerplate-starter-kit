// auto generated by kmigrator
// KMIGRATOR:0016_auto_20200627_1002:IyBHZW5lcmF0ZWQgYnkgRGphbmdvIDMuMC42IG9uIDIwMjAtMDYtMjcgMTA6MDIKCmltcG9ydCBkamFuZ28uY29udHJpYi5wb3N0Z3Jlcy5maWVsZHMuanNvbmIKZnJvbSBkamFuZ28uZGIgaW1wb3J0IG1pZ3JhdGlvbnMsIG1vZGVscwppbXBvcnQgZGphbmdvLmRiLm1vZGVscy5kZWxldGlvbgoKCmNsYXNzIE1pZ3JhdGlvbihtaWdyYXRpb25zLk1pZ3JhdGlvbik6CgogICAgZGVwZW5kZW5jaWVzID0gWwogICAgICAgICgnX2RqYW5nb19zY2hlbWEnLCAnMDAxNV9hdXRvXzIwMjAwNjA5XzIxMTYnKSwKICAgIF0KCiAgICBvcGVyYXRpb25zID0gWwogICAgICAgIG1pZ3JhdGlvbnMuQWx0ZXJGaWVsZCgKICAgICAgICAgICAgbW9kZWxfbmFtZT0nZm9yZ290cGFzc3dvcmRhY3Rpb24nLAogICAgICAgICAgICBuYW1lPSd1c2VyJywKICAgICAgICAgICAgZmllbGQ9bW9kZWxzLkZvcmVpZ25LZXkoZGJfY29sdW1uPSd1c2VyJywgb25fZGVsZXRlPWRqYW5nby5kYi5tb2RlbHMuZGVsZXRpb24uQ0FTQ0FERSwgcmVsYXRlZF9uYW1lPScrJywgdG89J19kamFuZ29fc2NoZW1hLnVzZXInKSwKICAgICAgICApLAogICAgICAgIG1pZ3JhdGlvbnMuQWx0ZXJGaWVsZCgKICAgICAgICAgICAgbW9kZWxfbmFtZT0nb3JnYW5pemF0aW9uJywKICAgICAgICAgICAgbmFtZT0nbmFtZScsCiAgICAgICAgICAgIGZpZWxkPW1vZGVscy5UZXh0RmllbGQoKSwKICAgICAgICApLAogICAgICAgIG1pZ3JhdGlvbnMuQWx0ZXJGaWVsZCgKICAgICAgICAgICAgbW9kZWxfbmFtZT0nb3JnYW5pemF0aW9udG91c2VybGluaycsCiAgICAgICAgICAgIG5hbWU9J3JvbGUnLAogICAgICAgICAgICBmaWVsZD1tb2RlbHMuQ2hhckZpZWxkKGNob2ljZXM9Wygnb3duZXInLCAnb3duZXInKSwgKCdtZW1iZXInLCAnbWVtYmVyJyldLCBtYXhfbGVuZ3RoPTUwKSwKICAgICAgICApLAogICAgICAgIG1pZ3JhdGlvbnMuQWx0ZXJGaWVsZCgKICAgICAgICAgICAgbW9kZWxfbmFtZT0ndXNlcicsCiAgICAgICAgICAgIG5hbWU9J3NldHRpbmdzJywKICAgICAgICAgICAgZmllbGQ9ZGphbmdvLmNvbnRyaWIucG9zdGdyZXMuZmllbGRzLmpzb25iLkpTT05GaWVsZChibGFuaz1UcnVlLCBudWxsPVRydWUpLAogICAgICAgICksCiAgICBdCg==

exports.up = async (knex) => {
    await knex.raw(`
    BEGIN;
--
-- Alter field user on forgotpasswordaction
--
SET CONSTRAINTS "ForgotPasswordAction_user_3c52ec86_fk_User_id" IMMEDIATE; ALTER TABLE "ForgotPasswordAction" DROP CONSTRAINT "ForgotPasswordAction_user_3c52ec86_fk_User_id";

-- DELETE USELESS DATA!
DELETE FROM "ForgotPasswordAction" t where t."user" is NULL;

ALTER TABLE "ForgotPasswordAction" ALTER COLUMN "user" SET NOT NULL;
ALTER TABLE "ForgotPasswordAction" ADD CONSTRAINT "ForgotPasswordAction_user_3c52ec86_fk_User_id" FOREIGN KEY ("user") REFERENCES "User" ("id") DEFERRABLE INITIALLY DEFERRED;
--
-- Alter field name on organization
--
ALTER TABLE "Organization" ALTER COLUMN "name" SET NOT NULL;
--
-- Alter field role on organizationtouserlink
--
ALTER TABLE "OrganizationToUserLink" ALTER COLUMN "role" SET NOT NULL;
--
-- Alter field settings on user
--
ALTER TABLE "User" ALTER COLUMN "settings" TYPE jsonb USING "settings"::jsonb;
COMMIT;

    `)
}

exports.down = async (knex) => {
    await knex.raw(`
    BEGIN;
--
-- Alter field settings on user
--
ALTER TABLE "User" ALTER COLUMN "settings" TYPE text USING "settings"::text;
--
-- Alter field role on organizationtouserlink
--
ALTER TABLE "OrganizationToUserLink" ALTER COLUMN "role" DROP NOT NULL;
--
-- Alter field name on organization
--
ALTER TABLE "Organization" ALTER COLUMN "name" DROP NOT NULL;
--
-- Alter field user on forgotpasswordaction
--
SET CONSTRAINTS "ForgotPasswordAction_user_3c52ec86_fk_User_id" IMMEDIATE; ALTER TABLE "ForgotPasswordAction" DROP CONSTRAINT "ForgotPasswordAction_user_3c52ec86_fk_User_id";
ALTER TABLE "ForgotPasswordAction" ALTER COLUMN "user" DROP NOT NULL;
ALTER TABLE "ForgotPasswordAction" ADD CONSTRAINT "ForgotPasswordAction_user_3c52ec86_fk_User_id" FOREIGN KEY ("user") REFERENCES "User" ("id") DEFERRABLE INITIALLY DEFERRED;
COMMIT;

    `)
}
